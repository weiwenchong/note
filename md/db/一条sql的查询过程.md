# 一条sql的执行过程

## Mysql基础架构
### 概览
Mysql主要分为Server层和存储引擎层.
* Server:包括连接器、查询缓存、分析器、优化器、执行器等,所有跨存储引擎的功能都在这一层实现,还有一个通用的日志模块binglog.
* 存储引擎:主要负责数据的存储和读取,采用可以替换的插件式架构,支持InnoDB、MyISAM等,InnoDB有自己的日志redolog,从Mysql5.5.5开始被作为默认存储引擎.
主要组件:
* 连接器:身份认证和权限相关.
* 查询缓存:执行查询语句的时候会先查询缓存,Mysql8.0后会移除.
* 分析器:分析sql语句要干嘛,检查语句是否正确.
* 优化器:按照Mysql认为最优的方案去执行.
* 执行器:执行语句,从查询引擎拿到数据.

### 组件介绍
1. 连接器  
主要负责用户身份认证,拿到的权限配置会决定是否能执行后续的操作,对这个连接后面所有的请求都生效,也就是说如果改了权限,需要重新登陆,不然不会生效.
2. 查询缓存
8.0后删除.
3. 分析器
词法分析,做什么操作;语法分析,判断是否正确.
4. 优化器
以Mysql认为最好的方法去执行.
5. 执行器
校验权限,通过的话就去执行这条sql.

## 语句分析
### 查询语句
1. 受限校验权限,无权限直接返回.
2. 8.0前会先查询缓存,如果缓存里有就直接返回,没有就继续执行.
3. 分析器进行提取关键元素,如动作,表名,查询列等;随后判断是否有语法错误,没问题就进行下一步.
4. 优化器按自己认为最好的进行优化,确认后开始执行.
5. 权限校验,没有权限会直接返回(与上面权限校验不同的是,上面的是登陆时的校验,这里是执行查询前的校验,如果此次sql的数据库的连接不是新建的,那就不会有上面的权限校验).
6. 执行语句,进入innodb引擎查询数据,然后返回.
### 更新语句
语句也会按照上一个查询的流程走,更新流程如下:
1. 先查询到这条数据.
2. 拿到这条记录,修改后调用引擎写入这一数据,InnoDB把数据保存在内存中,同时记录redo log,此时redo log进入prepare状态,告诉执行期执行完成,可以提交.
3. 执行器收到后记录到binlog里,调用引擎,提交redo log.
4. 更新完成.

## 流程总结
1. 查询: 权限校验-查询缓存-分析器-优化器-权限校验-执行器-引擎.
2. 更新: 分析器-权限校验-执行器-引擎-redo log prepare-binlog-redo log commit.
